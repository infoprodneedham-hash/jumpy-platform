<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stumpy's Great Rescue - Audio Edition</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #222; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas { 
            background: linear-gradient(#1a2a6c, #b21f1f, #fdbb2d); 
            border: 5px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            text-shadow: 2px 2px 2px black;
        }
    </style>
</head>
<body>

<div id="ui">
    HEALTH: <span id="health">100</span>%<br>
    FAIRIES: <span id="score">0</span>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 400;

// --- AUDIO SYSTEM ---
let audioCtx = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function playSound(freq, type, duration, vol = 0.1) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    
    gain.connect(audioCtx.destination);
    osc.connect(gain);
    
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

// --- GAME CONFIG ---
let player = { 
    x: 50, y: 300, w: 25, h: 35, 
    dx: 0, dy: 0, 
    health: 100, score: 0, 
    grounded: false, 
    dead: false,
    win: false
};

let cameraX = 0;
const gravity = 0.7;
const jumpPower = -14;
const moveSpeed = 5;
const gameStartTime = Date.now();

let platforms = [
    { x: 0, y: 350, w: 300, h: 50, sink: false },
    { x: 400, y: 280, w: 120, h: 20, sink: true, speed: 0 },
    { x: 600, y: 220, w: 120, h: 20, sink: true, speed: 0 },
    { x: 850, y: 300, w: 150, h: 20, sink: false },
    { x: 1100, y: 350, w: 400, h: 100, sink: false, castle: true }
];

let turrets = [
    { x: 250, y: 320, lastShot: 0 },
    { x: 880, y: 270, lastShot: 0 }
];

let fireballs = [];
let fairies = [
    { x: 450, y: 200, collected: false },
    { x: 650, y: 140, collected: false },
    { x: 920, y: 220, collected: false }
];

let keys = {};
window.onkeydown = (e) => {
    initAudio(); // Resume/Start audio context on user input
    keys[e.code] = true;
};
window.onkeyup = (e) => keys[e.code] = false;

function update() {
    if (player.dead || player.win) return;

    // Movement
    if (keys['ArrowRight'] || keys['KeyD']) player.dx = moveSpeed;
    else if (keys['ArrowLeft'] || keys['KeyA']) player.dx = -moveSpeed;
    else player.dx = 0;

    if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && player.grounded) {
        player.dy = jumpPower;
        player.grounded = false;
        playSound(150, 'square', 0.1); // Jump Sound
    }

    // Physics
    player.x += player.dx;
    player.dy += gravity;
    player.y += player.dy;
    player.grounded = false;

    cameraX = Math.max(0, player.x - 200);

    // Collisions: Platforms
    platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x &&
            player.y + player.h > p.y && player.y + player.h < p.y + player.dy + 10) {
            player.dy = 0;
            player.y = p.y - player.h;
            player.grounded = true;
            if (p.sink) {
                p.speed += 0.15;
                p.y += p.speed;
            }
            if (p.castle && player.x > p.x + 100) {
                player.win = true;
                playSound(500, 'sine', 0.3);
                setTimeout(() => playSound(700, 'sine', 0.5), 100);
            }
        }
    });

    // Turrets & Fireballs
    let now = Date.now();
    let timeElapsed = now - gameStartTime;

    // Only fire if 5 seconds have passed
    if (timeElapsed > 5000) {
        turrets.forEach(t => {
            if (now - t.lastShot > 2000 && Math.abs(player.x - t.x) < 500) {
                fireballs.push({ x: t.x, y: t.y, dx: -4 });
                t.lastShot = now;
                playSound(100, 'sawtooth', 0.1, 0.05); // Turret Sound
            }
        });
    }

    fireballs.forEach((f, index) => {
        f.x += f.dx;
        if (f.x < player.x + player.w && f.x + 15 > player.x &&
            f.y < player.y + player.h && f.y + 15 > player.y) {
            player.health -= 25;
            fireballs.splice(index, 1);
            playSound(60, 'sawtooth', 0.2); // Hit Sound
        }
        if (f.x < cameraX - 100) fireballs.splice(index, 1);
    });

    // Fairies
    fairies.forEach(f => {
        if (!f.collected && Math.hypot(player.x - f.x, player.y - f.y) < 30) {
            f.collected = true;
            player.score++;
            player.health = Math.min(100, player.health + 20);
            playSound(880, 'sine', 0.2); // Fairy Sound
        }
    });

    if (player.y > canvas.height || player.health <= 0) {
        player.dead = true;
        playSound(40, 'square', 0.4); // Death Sound
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(-cameraX, 0);

    // Draw Platforms
    platforms.forEach(p => {
        ctx.fillStyle = p.castle ? "#555" : (p.sink ? "#633" : "#444");
        ctx.fillRect(p.x, p.y, p.w, p.h);
        if(p.castle) {
            ctx.fillStyle = "#333";
            ctx.fillRect(p.x + 150, p.y - 100, 200, 100);
            ctx.fillStyle = "pink"; 
            ctx.fillRect(p.x + 240, p.y - 40, 20, 40);
        }
    });

    // Draw Turrets
    ctx.fillStyle = "#222";
    turrets.forEach(t => ctx.fillRect(t.x, t.y, 30, 30));

    // Draw Fireballs
    ctx.fillStyle = "#ff4500";
    fireballs.forEach(f => {
        ctx.beginPath();
        ctx.arc(f.x, f.y + 15, 8, 0, Math.PI*2);
        ctx.fill();
    });

    // Draw Fairies
    ctx.fillStyle = `hsla(60, 100%, 50%, ${0.5 + Math.sin(Date.now()/200)*0.5})`;
    fairies.forEach(f => {
        if (!f.collected) {
            ctx.beginPath();
            ctx.arc(f.x, f.y + Math.sin(Date.now()/300)*5, 10, 0, Math.PI*2);
            ctx.fill();
        }
    });

    // Draw Stumpy
    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    const px = player.x + 12;
    const py = player.y;
    ctx.strokeRect(px - 5, py - 15, 10, 10);
    ctx.beginPath();
    ctx.moveTo(px, py - 5); ctx.lineTo(px, py + 15);
    ctx.moveTo(px - 10, py + 5); ctx.lineTo(px + 10, py + 5);
    ctx.moveTo(px, py + 15); ctx.lineTo(px - 8, py + 30);
    ctx.moveTo(px, py + 15); ctx.lineTo(px + 8, py + 30);
    ctx.stroke();

    ctx.restore();

    // UI Update
    document.getElementById('health').innerText = player.health;
    document.getElementById('score').innerText = player.score;

    // Turret Warning UI
    let timeElapsed = Date.now() - gameStartTime;
    if (timeElapsed < 5000 && !player.dead && !player.win) {
        ctx.fillStyle = "yellow";
        ctx.font = "bold 16px Courier";
        let timeLeft = Math.ceil((5000 - timeElapsed) / 1000);
        ctx.fillText("TURRETS OFFLINE - STARTING IN: " + timeLeft + "s", 240, 40);
    }

    if (player.dead) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.font = "20px Courier";
        ctx.fillText("GAME OVER - PRESS F5 TO RESTART", 230, 200);
    }
    if (player.win) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "gold";
        ctx.font = "30px Courier";
        ctx.fillText("YOU SAVED THE PRINCESS!", 200, 200);
    }
}

update();
</script>
</body>
</html>
