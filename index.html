<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stumpy's Rescue - Fixed Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: 'Courier New', Courier, monospace; }
        canvas { border: 5px solid #444; background: #000; }
        #ui { position: absolute; top: 20px; left: 20px; pointer-events: none; text-shadow: 2px 2px 2px black; line-height: 1.5; }
    </style>
</head>
<body>

<div id="ui">
    STAGE: <span id="stage">1</span>/5 | LIVES: <span id="lives">5</span><br>
    HEALTH: <span id="health">100</span>% | FAIRIES: <span id="score">0</span>
    <div id="boss-ui" style="display:none; color: #ff0044;">BOSS HP: <span id="boss-hp">5</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 400;

let audioCtx = null;
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playSfx(f, t, d, v=0.1, s=0) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    if(s) o.frequency.exponentialRampToValueAtTime(f+s, audioCtx.currentTime+d);
    g.connect(audioCtx.destination); o.connect(g);
    g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+d);
    o.start(); o.stop(audioCtx.currentTime+d);
}

let stage = 1;
let player = { x: 50, y: 300, w: 20, h: 30, dx: 0, dy: 0, health: 100, lives: 5, score: 0, grounded: false, hasGun: false, attachedPlatform: null };
let boss = { x: 1200, y: 150, w: 80, h: 100, hp: 5, active: false };
let platforms = [], turrets = [], enemies = [], fireballs = [], fairies = [], ropes = [], bullets = [];
let cameraX = 0;
const gravity = 0.6;

function loadStage(num) {
    // Reset player position safely on a platform
    player.x = 40; 
    player.y = 250; 
    player.dy = 0;
    player.health = 100;
    player.attachedPlatform = null;
    fireballs = []; bullets = []; 
    boss.active = (num === 5);
    
    if (num === 1) {
        // Wider start platform (x:0 to 400) to prevent falling on spawn
        platforms = [
            {x:0, y:320, w:450, h:80}, 
            {x:500, y:240, w:180, h:20}, 
            {x:750, y:320, w:400, h:80, exit:true}
        ];
        enemies = [{x:800, y:300, range:100, dir:1, startX:800, dead: false}];
        turrets = [{x:550, y:210}];
        fairies = [{x:580, y:150}];
        ropes = [];
    } else if (num === 2) {
        platforms = [{x:0, y:320, w:200, h:20}, {x:250, y:240, w:150, h:20}, {x:100, y:160, w:150, h:20}, {x:400, y:120, w:150, h:20}, {x:700, y:250, w:300, h:20, exit:true}];
        enemies = [{x:750, y:230, range:100, dir:1, startX:750, dead: false}];
        turrets = [{x:20, y:290}, {x:450, y:90}];
        fairies = [{x:150, y:100}];
    } else if (num === 3) {
        platforms = [
            {x:0, y:320, w:200, h:20}, 
            {x:300, y:300, w:150, h:20, move:true, startX:300, dist:150, speed: 0.002, lastX: 300}, 
            {x:600, y:220, w:150, h:20, move:true, startX:600, dist:120, speed: 0.003, lastX: 600}, 
            {x:950, y:320, w:400, h:80, exit:true}
        ];
        enemies = [{x:1000, y:300, range:150, dir:1, startX:1000, dead: false}];
        turrets = [{x:1100, y:290}];
    } else if (num === 4) {
        platforms = [
            {x:0, y:320, w:150, h:20}, 
            {x:200, y:250, w:120, h:20, move:true, startX:200, dist:200, speed:0.004, lastX:200},
            {x:600, y:180, w:120, h:20}, 
            {x:850, y:300, w:400, h:80, exit:true}
        ];
        turrets = [{x:220, y:220}, {x:620, y:150}];
        enemies = [{x:950, y:280, range:200, dir:1, startX:950, dead: false}];
    } else if (num === 5) {
        platforms = [
            {x:0, y:320, w:400, h:80}, 
            {x:450, y:320, w:1000, h:80}, 
            {x:50, y:100, w:120, h:20, hasGun: true}, 
            {x:1250, y:180, w:150, h:20, princess: true}
        ];
        ropes = [{x:100, y:100, h:220}];
        document.getElementById('boss-ui').style.display = 'block';
    }
}

let keys = {};
window.onkeydown = (e) => { initAudio(); keys[e.code] = true; if(e.code==='KeyF' && player.hasGun) shoot(); };
window.onkeyup = (e) => keys[e.code] = false;

function shoot() {
    bullets.push({x: player.x+20, y: player.y+10, dx: 12});
    playSfx(1000, 'sine', 0.1, 0.1, 200);
}

function update() {
    if (player.lives <= 0 || (stage === 5 && boss.hp <= -1)) return;

    if (keys['ArrowRight'] || keys['KeyD']) player.dx = 5;
    else if (keys['ArrowLeft'] || keys['KeyA']) player.dx = -5;
    else player.dx = 0;

    let onRope = ropes.some(r => player.x+10 > r.x-20 && player.x+10 < r.x+20 && player.y < r.y+r.h && player.y+player.h > r.y);
    if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW'])) {
        if (onRope) { player.y -= 5; player.dy = 0; }
        else if (player.grounded) { player.dy = -13.5; player.grounded = false; playSfx(150, 'square', 0.1); }
    }

    if (player.attachedPlatform) {
        player.x += (player.attachedPlatform.x - player.attachedPlatform.lastX);
    }

    player.x += player.dx;
    if (!onRope) { player.dy += gravity; player.y += player.dy; }
    player.grounded = false;
    player.attachedPlatform = null;

    cameraX = Math.max(0, player.x - 200);

    platforms.forEach(p => {
        if (p.move) { 
            p.lastX = p.x;
            p.x = p.startX + Math.sin(Date.now() * p.speed) * p.dist; 
        }
        // Collision Detection
        if (player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h > p.y && player.y + player.h < p.y + player.dy + 12) {
            player.dy = 0; player.y = p.y - player.h; player.grounded = true;
            player.attachedPlatform = p;
            if (p.exit) { stage++; loadStage(stage); }
            if (p.hasGun && !player.hasGun) { player.hasGun = true; playSfx(600, 'sawtooth', 0.3); }
            if (p.princess && boss.hp <= 0) { boss.hp = -1; playSfx(500, 'sine', 1); }
        }
    });

    enemies.forEach(e => {
        if (e.dead) return;
        e.x += e.dir * 2;
        if (Math.abs(e.x - e.startX) > e.range) e.dir *= -1;
        if (player.x < e.x + 25 && player.x + player.w > e.x && player.y + player.h > e.y && player.y + player.h < e.y + 15 && player.dy > 0) {
            e.dead = true; player.dy = -10; playSfx(300, 'square', 0.1);
        } else if (Math.hypot(player.x - e.x, player.y - e.y) < 25) {
            player.health -= 1.5;
        }
    });

    let now = Date.now();
    turrets.forEach(t => {
        if (now - (t.lastShot || 0) > 2000 && Math.abs(player.x - t.x) < 500) {
            fireballs.push({ x: t.x, y: t.y, dx: -5.5 });
            t.lastShot = now; playSfx(80, 'sawtooth', 0.1, 0.05);
        }
    });

    fireballs.forEach((f, i) => {
        f.x += f.dx;
        if (f.x < player.x + player.w && f.x + 10 > player.x && f.y < player.y + player.h && f.y + 10 > player.y) {
            player.health -= 25; fireballs.splice(i, 1); playSfx(40, 'sawtooth', 0.2);
        }
    });

    bullets.forEach((b, i) => {
        b.x += b.dx;
        if (boss.active && b.x > boss.x && b.x < boss.x + boss.w && b.y > boss.y && b.y < boss.y + boss.h) {
            boss.hp--; bullets.splice(i, 1); playSfx(200, 'square', 0.1, 0.2, 200);
        }
    });

    fairies.forEach(f => {
        if (!f.collected && Math.hypot(player.x - f.x, player.y - f.y) < 30) {
            f.collected = true; player.score++; player.health = Math.min(100, player.health + 20); playSfx(1000, 'sine', 0.2);
        }
    });

    if (boss.active && boss.hp > 0) {
        boss.y = 120 + Math.sin(now/400) * 70;
        if (now % 70 < 10) fireballs.push({x: boss.x, y: boss.y + Math.random()*100, dx: -8});
    }

    if (player.y > 450 || player.health <= 0) {
        player.lives--;
        if (player.lives > 0) loadStage(stage);
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0,0,800,400);
    ctx.save(); ctx.translate(-cameraX, 0);

    platforms.forEach(p => {
        ctx.fillStyle = p.exit ? "#00ff00" : (p.move ? "#00bbff" : "#444");
        ctx.fillRect(p.x, p.y, p.w, p.h);
        if(p.hasGun && !player.hasGun) { ctx.fillStyle="cyan"; ctx.fillRect(p.x+50, p.y-15, 20, 10); }
        if(p.princess) { ctx.fillStyle="#ff66cc"; ctx.fillRect(p.x+60, p.y-40, 25, 40); }
    });

    ropes.forEach(r => { ctx.strokeStyle="#8b4513"; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(r.x, r.y); ctx.lineTo(r.x, r.y+r.h); ctx.stroke(); });
    enemies.forEach(e => { if(!e.dead){ ctx.fillStyle="#00cc00"; ctx.fillRect(e.x, e.y, 25, 20); }});
    turrets.forEach(t => { ctx.fillStyle="#222"; ctx.fillRect(t.x, t.y, 30, 30); });
    fireballs.forEach(f => { ctx.fillStyle="#ff4400"; ctx.beginPath(); ctx.arc(f.x, f.y+10, 8, 0, Math.PI*2); ctx.fill(); });
    bullets.forEach(b => { ctx.fillStyle="cyan"; ctx.fillRect(b.x, b.y, 12, 4); });
    fairies.forEach(f => { if(!f.collected) { ctx.fillStyle="#ffff00"; ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2); ctx.fill(); }});

    if (boss.active && boss.hp > 0) {
        ctx.fillStyle = "#300"; ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
        ctx.fillStyle = "#f00"; ctx.fillRect(boss.x+15, boss.y+20, 15, 15); ctx.fillRect(boss.x+50, boss.y+20, 15, 15);
    }

    // Player
    ctx.strokeStyle = player.hasGun ? "cyan" : "white"; ctx.lineWidth = 3;
    ctx.strokeRect(player.x+5, player.y-5, 10, 10);
    ctx.beginPath(); ctx.moveTo(player.x+10, player.y+5); ctx.lineTo(player.x+10, player.y+25); ctx.stroke();
    if(player.hasGun) { ctx.fillStyle="cyan"; ctx.fillRect(player.x+15, player.y+12, 12, 6); }

    ctx.restore();

    document.getElementById('health').innerText = Math.max(0, Math.ceil(player.health));
    document.getElementById('score').innerText = player.score;
    document.getElementById('lives').innerText = player.lives;
    document.getElementById('stage').innerText = stage;
    document.getElementById('boss-hp').innerText = Math.max(0, boss.hp);

    if (player.lives <= 0) { ctx.fillStyle="red"; ctx.font="bold 40px Courier"; ctx.fillText("GAME OVER", 300, 200); }
    if (boss.hp <= -1) { ctx.fillStyle="gold"; ctx.font="bold 30px Courier"; ctx.fillText("PRINCESS SAVED! THE HERO PREVAILS!", 120, 200); }
}

loadStage(1);
update();
</script>
</body>
</html>
