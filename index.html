<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stumpy's Great Rescue</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #222; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas { 
            background: linear-gradient(#1a2a6c, #b21f1f, #fdbb2d); 
            border: 5px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="ui">
    HEALTH: <span id="health">100</span>%<br>
    FAIRIES: <span id="score">0</span>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 400;

// Game Config & Assets
let player = { 
    x: 50, y: 300, w: 25, h: 35, 
    dx: 0, dy: 0, 
    health: 100, score: 0, 
    grounded: false, 
    dead: false,
    win: false
};

let cameraX = 0;
const gravity = 0.7;
const jumpPower = -14;
const moveSpeed = 5;

// Level Design
let platforms = [
    { x: 0, y: 350, w: 300, h: 50, sink: false },
    { x: 400, y: 280, w: 120, h: 20, sink: true, speed: 0 },
    { x: 600, y: 220, w: 120, h: 20, sink: true, speed: 0 },
    { x: 850, y: 300, w: 150, h: 20, sink: false },
    { x: 1100, y: 350, w: 400, h: 100, sink: false, castle: true }
];

let turrets = [
    { x: 250, y: 320, lastShot: 0 },
    { x: 880, y: 270, lastShot: 0 }
];

let fireballs = [];
let fairies = [
    { x: 450, y: 200, collected: false },
    { x: 650, y: 140, collected: false },
    { x: 920, y: 220, collected: false }
];

// Input Controls
let keys = {};
window.onkeydown = (e) => keys[e.code] = true;
window.onkeyup = (e) => keys[e.code] = false;

function update() {
    if (player.dead || player.win) return;

    // Movement
    if (keys['ArrowRight'] || keys['KeyD']) player.dx = moveSpeed;
    else if (keys['ArrowLeft'] || keys['KeyA']) player.dx = -moveSpeed;
    else player.dx = 0;

    if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && player.grounded) {
        player.dy = jumpPower;
        player.grounded = false;
    }

    // Physics
    player.x += player.dx;
    player.dy += gravity;
    player.y += player.dy;
    player.grounded = false;

    // Camera follow (keep player in the first 1/3 of the screen)
    cameraX = Math.max(0, player.x - 200);

    // Collisions: Platforms
    platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x &&
            player.y + player.h > p.y && player.y + player.h < p.y + player.dy + 10) {
            player.dy = 0;
            player.y = p.y - player.h;
            player.grounded = true;
            if (p.sink) {
                p.speed += 0.15;
                p.y += p.speed;
            }
            if (p.castle && player.x > p.x + 100) player.win = true;
        }
    });

    // Turrets & Fireballs
    let now = Date.now();
    turrets.forEach(t => {
        if (now - t.lastShot > 2000 && Math.abs(player.x - t.x) < 500) {
            fireballs.push({ x: t.x, y: t.y, dx: -4 });
            t.lastShot = now;
        }
    });

    fireballs.forEach((f, index) => {
        f.x += f.dx;
        // Hit detection
        if (f.x < player.x + player.w && f.x + 15 > player.x &&
            f.y < player.y + player.h && f.y + 15 > player.y) {
            player.health -= 25;
            fireballs.splice(index, 1);
        }
        // Clean up off-screen fireballs
        if (f.x < cameraX - 100) fireballs.splice(index, 1);
    });

    // Fairies
    fairies.forEach(f => {
        if (!f.collected && Math.hypot(player.x - f.x, player.y - f.y) < 30) {
            f.collected = true;
            player.score++;
            player.health = Math.min(100, player.health + 20);
        }
    });

    // Death condition
    if (player.y > canvas.height || player.health <= 0) {
        player.dead = true;
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(-cameraX, 0);

    // Draw Platforms
    platforms.forEach(p => {
        ctx.fillStyle = p.castle ? "#555" : (p.sink ? "#633" : "#444");
        ctx.fillRect(p.x, p.y, p.w, p.h);
        if(p.castle) {
            // Draw Castle Walls
            ctx.fillStyle = "#333";
            ctx.fillRect(p.x + 150, p.y - 100, 200, 100);
            ctx.fillStyle = "pink"; // The Princess
            ctx.fillRect(p.x + 240, p.y - 40, 20, 40);
        }
    });

    // Draw Turrets
    ctx.fillStyle = "#222";
    turrets.forEach(t => ctx.fillRect(t.x, t.y, 30, 30));

    // Draw Fireballs
    ctx.fillStyle = "#ff4500";
    fireballs.forEach(f => {
        ctx.beginPath();
        ctx.arc(f.x, f.y + 15, 8, 0, Math.PI*2);
        ctx.fill();
    });

    // Draw Fairies (Twinkling)
    ctx.fillStyle = `hsla(60, 100%, 50%, ${0.5 + Math.sin(Date.now()/200)*0.5})`;
    fairies.forEach(f => {
        if (!f.collected) {
            ctx.beginPath();
            ctx.arc(f.x, f.y + Math.sin(Date.now()/300)*5, 10, 0, Math.PI*2);
            ctx.fill();
        }
    });

    // Draw Stumpy Stick Figure
    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    const px = player.x + 12;
    const py = player.y;
    // Head
    ctx.strokeRect(px - 5, py - 15, 10, 10);
    // Body
    ctx.beginPath();
    ctx.moveTo(px, py - 5); ctx.lineTo(px, py + 15);
    // Arms
    ctx.moveTo(px - 10, py + 5); ctx.lineTo(px + 10, py + 5);
    // Legs
    ctx.moveTo(px, py + 15); ctx.lineTo(px - 8, py + 30);
    ctx.moveTo(px, py + 15); ctx.lineTo(px + 8, py + 30);
    ctx.stroke();

    ctx.restore();

    // UI Update
    document.getElementById('health').innerText = player.health;
    document.getElementById('score').innerText = player.score;

    // Overlay Screens
    if (player.dead) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.fillText("GAME OVER - PRESS F5 TO RESTART", 280, 200);
    }
    if (player.win) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "gold";
        ctx.font = "30px Courier";
        ctx.fillText("YOU SAVED THE PRINCESS!", 200, 200);
    }
}

update();
</script>
</body>
</html>
