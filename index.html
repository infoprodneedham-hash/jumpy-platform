<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickman Hero: Princess Rescue</title>
    <style>
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: sans-serif; overflow: hidden; }
        canvas { background: #87CEEB; border: 4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #ui { position: absolute; top: 20px; left: 20px; font-size: 20px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">Coins: <span id="coinCount">0</span> | Screen: <span id="screenNum">1</span></div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const coinDisplay = document.getElementById('coinCount');
const screenDisplay = document.getElementById('screenNum');

canvas.width = 800;
canvas.height = 400;

// Game State
let currentScreen = 1;
let coins = 0;
let gameOver = false;
let gameWin = false;

// Physics Constants
const gravity = 0.5;
const friction = 0.8;

// Player Object
const player = {
    x: 50, y: 300, w: 20, h: 40,
    vx: 0, vy: 0,
    speed: 5, jumpPower: -10,
    grounded: false,
    hasRaygun: false,
    isSwinging: false,
    ropeAngle: 0,
    ropeLength: 150,
    ropeAnchor: { x: 400, y: 0 }
};

// Controls
const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

// Entities
let platforms = [];
let hazards = []; // Fireballs, water, alien
let collectibles = []; // Coins, raygun
let boss = { x: 600, y: 200, w: 60, h: 80, hp: 3, alive: true };
let projectiles = [];
let turretTimer = 0;

function initScreen(num) {
    currentScreen = num;
    screenDisplay.innerText = num;
    platforms = [];
    hazards = [];
    collectibles = [];
    projectiles = [];
    player.vx = 0;
    player.vy = 0;
    
    if (num === 1) {
        player.x = 50;
        platforms.push({x: 0, y: 350, w: 200, h: 50}, {x: 300, y: 250, w: 150, h: 20}, {x: 600, y: 350, w: 200, h: 50});
        // Turret is at 375, 230
    } else if (num === 2) {
        player.x = 20;
        platforms.push({x: 0, y: 350, w: 100, h: 50}, {x: 700, y: 350, w: 100, h: 50});
        collectibles.push({x: 250, y: 200, type: 'coin'}, {x: 400, y: 150, type: 'coin'}, {x: 550, y: 200, type: 'coin'});
    } else if (num === 3) {
        player.x = 20;
        platforms.push({x: 0, y: 350, w: 100, h: 50}, {x: 300, y: 300, w: 150, h: 20, moving: true, range: 100, startX: 300}, {x: 700, y: 350, w: 100, h: 50});
        hazards.push({x: 500, y: 100, w: 30, h: 30, type: 'alien_drone'});
    } else if (num === 4) {
        player.x = 20;
        platforms.push({x: 0, y: 350, w: 800, h: 50}, {x: 50, y: 150, w: 100, h: 20});
        collectibles.push({x: 70, y: 110, type: 'raygun'});
    }
}

function update() {
    if (gameOver || gameWin) return;

    // Movement
    if (keys['ArrowLeft']) player.vx = -player.speed;
    else if (keys['ArrowRight']) player.vx = player.speed;
    else player.vx *= friction;

    if (keys['Space'] && player.grounded) {
        player.vy = player.jumpPower;
        player.grounded = false;
    }

    // Gravity
    player.vy += gravity;
    player.x += player.vx;
    player.y += player.vy;

    // Screen Transition
    if (player.x > canvas.width) {
        if (currentScreen < 4) initScreen(currentScreen + 1);
        else player.x = canvas.width - player.w;
    }
    if (player.x < 0) player.x = 0;

    // Platform Collision
    player.grounded = false;
    platforms.forEach(p => {
        if (p.moving) {
            p.x = p.startX + Math.sin(Date.now() / 500) * p.range;
        }
        if (player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h > p.y && player.y + player.h < p.y + p.vy + 10) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.grounded = true;
            if (p.moving) player.x += Math.cos(Date.now() / 500) * 2; // Simple stickiness
        }
    });

    // Screen 1: Turret Logic
    if (currentScreen === 1) {
        turretTimer++;
        if (turretTimer > 180) { // 3 seconds at 60fps
            hazards.push({x: 375, y: 235, vx: 4, vy: 0, w: 10, h: 10, type: 'fireball'});
            hazards.push({x: 375, y: 235, vx: -4, vy: 0, w: 10, h: 10, type: 'fireball'});
            turretTimer = 0;
        }
    }

    // Screen 2: Rope Logic (Simplified as proximity-based swing)
    if (currentScreen === 2) {
        if (player.y > 360) gameOver = true; // Water
        let dist = Math.hypot(player.x - 400, player.y - 0);
        if (dist < 250 && keys['ShiftLeft']) {
            player.isSwinging = true;
            player.vy = -2; // Cheat physics for "swinging" feel
            player.vx += (player.x < 400) ? 0.5 : -0.5;
        }
    }

    // Screen 3: Alien Drone Logic
    if (currentScreen === 3) {
        hazards.forEach(h => {
            if (h.type === 'alien_drone') {
                h.x += (player.x - h.x) * 0.01;
                h.y += (player.y - h.y) * 0.01;
            }
        });
    }

    // Screen 4: Boss & Raygun
    if (currentScreen === 4 && player.hasRaygun && keys['KeyF']) {
        if (projectiles.length < 1) {
            projectiles.push({x: player.x + 20, y: player.y + 10, vx: 7});
            keys['KeyF'] = false; // Semi-auto
        }
    }

    // Hazard & Collectible Logic
    hazards.forEach((h, i) => {
        h.x += h.vx || 0;
        if (rectIntersect(player, h)) gameOver = true;
    });

    collectibles.forEach((c, i) => {
        if (rectIntersect(player, c)) {
            if (c.type === 'coin') { coins++; coinDisplay.innerText = coins; }
            if (c.type === 'raygun') player.hasRaygun = true;
            collectibles.splice(i, 1);
        }
    });

    projectiles.forEach((p, i) => {
        p.x += p.vx;
        if (rectIntersect(p, boss) && boss.alive) {
            boss.hp--;
            projectiles.splice(i, 1);
            if (boss.hp <= 0) { boss.alive = false; gameWin = true; }
        }
    });

    if (player.y > canvas.height) gameOver = true;
}

function rectIntersect(r1, r2) {
    return r1.x < r2.x + (r2.w || 10) && r1.x + (r1.w || 10) > r2.x && r1.y < r2.y + (r2.h || 10) && r1.y + (r1.h || 10) > r2.y;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw Water for Screen 2
    if (currentScreen === 2) {
        ctx.fillStyle = '#0077be';
        ctx.fillRect(100, 360, 600, 40);
    }

    // Draw Platforms
    ctx.fillStyle = '#444';
    platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

    // Draw Hazards
    hazards.forEach(h => {
        ctx.fillStyle = h.type === 'fireball' ? 'orange' : 'green';
        ctx.beginPath();
        ctx.arc(h.x, h.y, 8, 0, Math.PI*2);
        ctx.fill();
    });

    // Draw Collectibles
    collectibles.forEach(c => {
        ctx.fillStyle = c.type === 'coin' ? 'gold' : 'blue';
        ctx.fillRect(c.x, c.y, 15, 15);
    });

    // Draw Projectiles
    ctx.fillStyle = 'cyan';
    projectiles.forEach(p => ctx.fillRect(p.x, p.y, 10, 4));

    // Draw Turret (Screen 1)
    if (currentScreen === 1) {
        ctx.fillStyle = 'black';
        ctx.fillRect(365, 230, 20, 20);
    }

    // Draw Boss & Princess (Screen 4)
    if (currentScreen === 4) {
        if (boss.alive) {
            ctx.fillStyle = 'purple';
            ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
        }
        // Cage
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeRect(700, 250, 50, 100);
        ctx.fillStyle = 'pink'; // Princess
        ctx.fillRect(715, 280, 20, 40);
    }

    // Draw Player (Stick Figure)
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    const {x, y, w, h} = player;
    ctx.beginPath();
    ctx.arc(x + w/2, y + 10, 8, 0, Math.PI*2); // Head
    ctx.moveTo(x + w/2, y + 18); ctx.lineTo(x + w/2, y + 30); // Body
    ctx.moveTo(x + w/2, y + 22); ctx.lineTo(x, y + 25); // Arms
    ctx.moveTo(x + w/2, y + 22); ctx.lineTo(x + w, y + 25);
    ctx.moveTo(x + w/2, y + 30); ctx.lineTo(x, y + 40); // Legs
    ctx.moveTo(x + w/2, y + 30); ctx.lineTo(x + w, y + 40);
    ctx.stroke();

    if (player.hasRaygun) {
        ctx.fillStyle = 'blue';
        ctx.fillRect(player.x + 15, player.y + 20, 10, 5);
    }

    if (gameOver) {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0,0,800,400);
        ctx.fillStyle = 'white';
        ctx.fillText("GAME OVER - Press R to Restart", 300, 200);
    }
    if (gameWin) {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0,0,800,400);
        ctx.fillStyle = 'yellow';
        ctx.fillText("YOU SAVED THE PRINCESS!", 300, 200);
    }
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

window.addEventListener('keydown', e => {
    if (e.code === 'KeyR' && (gameOver || gameWin)) {
        gameOver = false; gameWin = false; coins = 0; coinDisplay.innerText = 0;
        player.hasRaygun = false;
        initScreen(1);
    }
});

initScreen(1);
gameLoop();
</script>
</body>
</html>
